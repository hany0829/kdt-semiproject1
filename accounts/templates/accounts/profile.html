{% extends 'base.html' %}
{% load static %}


{% block content %}
<link rel="stylesheet" href="{% static 'css/update.css' %}">
<h1>회원정보</h1>
    <div class="profile-container">
        <div class="profile-box"></div>
        {% if request.user.is_authenticated %}
        <div class="d-flex flex-column mb-3 mt-3">
          <div class="profile-text">안녕하세요! <span>{{ user.username }}</span>님은 일반회원 입니다.</div>
          
          <div>
              팔로잉 : <span id="followings-count">{{ person.followings.all|length }}</span> / 
              팔로워 : <span id="followers-count">{{ person.followers.all|length }}</span>
            {% if request.user != person %}

                <form id="follow-form" data-user-id="{{ person.pk }}">
                  {% csrf_token %}
                  {% if request.user in person.followers.all %}
                    <input class="btn btn-danger btn-sm" type="submit" value="언팔로우">
                  {% else %}
                    <input class="btn btn-danger btn-sm"  type="submit" value="팔로우">
                  {% endif %}
                </form>

            {% endif %}
          </div>
        </div>



        {% endif %}
    </div>
    <div class="container">
        <form id="update-form" action="{% url 'accounts:update' %}" method="POST">
        {% csrf_token %}
        <div class="input-container">
            <label for="username">아이디</label>
            <input type="text" id="username" name="username" value="{{ user.username }}" required>
        </div>

        <div class="input-container">
            <label for="first_name">이름</label>
            <input type="text" id="first_name" name="first_name" value="{{user.first_name}}" required>
        </div>

        <div class="input-container">
            <label for="email">이메일</label>
            <input type="email" id="email" name="email" value="{{ user.email }}" required>
        </div>
        </form>

        <form id="logout-form" action="{% url 'accounts:logout' %}" method="POST">
            {% csrf_token %}
            <input type="submit" value="Logout">
        </form>

    </div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    const form = document.querySelector('#follow-form')
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value

    form.addEventListener('submit', function (event) {
      // 이벤트 기본 동작 취소
      event.preventDefault()

      // HTML로 부터 전달받은 프로필 유저의 PK
      const userId = event.target.dataset.userId
      
      // axios로 요청 보내기
      axios({
        method: 'post',
        url: `/accounts/${userId}/follow/`,
        headers: {'X-CSRFToken': csrftoken},
      })
        .then((response) => {
          // console.log(response.data)
          const isFollowed = response.data.is_followed
          const followBtn = document.querySelector('#follow-form > input[type=submit]')

          // isFollowed에 따라 버튼을 조작
          if (isFollowed === true) {
            followBtn.value = '언팔로우'
          } else {
            followBtn.value = '팔로우'
          }

          // 팔로잉&팔로워 수 DOM 조작
          const followingCountTag = document.querySelector('#followings-count')
          const followerCountTag = document.querySelector('#followers-count')

          const followingsCountData = response.data.followings_count
          const followersCountData = response.data.followers_count

          // 선택한 span 태그의 내용을 팔로잉과 팔로워 수 데이터로 채워넣기
          followingCountTag.textContent = followingsCountData
          followerCountTag.textContent = followersCountData
        })

    })
  </script>
{% endblock content %}


